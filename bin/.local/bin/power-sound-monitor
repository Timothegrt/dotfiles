#!/usr/bin/env bash
set -euo pipefail

LOW_THRESH="${LOW_THRESH:-15}"   # for low bat
THEME_DIR="${XDG_DATA_HOME:-$HOME/.local/share}/sounds/macOS-ish/stereo"

play_file() {
  local f="$1"
  [[ -f "$f" ]] || return 1
  pw-play "$f" >/dev/null 2>&1 || canberra-gtk-play -f "$f" >/dev/null 2>&1 || true
}

play_event() {
  case "$1" in
    plug)   play_file "$THEME_DIR/power-plug.ogg"   || canberra-gtk-play -i power-plug   ;;
    unplug) play_file "$THEME_DIR/power-unplug.ogg" || canberra-gtk-play -i power-unplug ;;
    low)    play_file "$THEME_DIR/battery-low.ogg"  || canberra-gtk-play -i battery-low  ;;
  esac
}

wait_upower() {
  for _ in {1..15}; do upower -e >/dev/null 2>&1 && return 0; sleep 1; done
  echo "upower not ready" >&2; exit 1
}

get_display_path() {
  upower -e | awk '/DisplayDevice/{print; exit}'
}

monitor() {
  local last_low=0
  upower --monitor-detail | while IFS= read -r line; do
    case "$line" in
      *"on-battery:"*)
        state="${line##*: }"; state="${state// /}"
        [[ "$state" == "yes" ]] && play_event unplug
        [[ "$state" == "no"  ]] && play_event plug
        ;;
      *"percentage:"*)
        p="${line##*: }"; p="${p%%%*}"; p="${p// /}"
        [[ "$p" =~ ^[0-9]+$ ]] || continue
        if (( p <= LOW_THRESH && ( last_low == 0 || p < last_low ) )); then
          play_event low
          last_low="$p"
        elif (( p > LOW_THRESH )); then
          last_low=0
        fi
        ;;
    esac
  done
}

wait_upower

monitor
